{% extends 'core/base.html' %}

{% block content %}

{% if overdue_payments %}
<div class="mb-6">
    <button onclick="document.getElementById('overdue-box').classList.toggle('hidden')" 
            class="w-full bg-red-50 border border-red-200 p-4 rounded-2xl flex justify-between items-center group hover:bg-red-100 transition-all shadow-sm">
        <div class="flex items-center text-left">
            <div class="p-2 bg-red-600 text-white rounded-lg mr-4 animate-pulse">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div>
                <p class="text-red-700 font-black text-sm uppercase tracking-tighter">Pichli Baki Vasuli (Defaulters)</p>
                <p class="text-red-500 text-[10px] font-bold">{{ overdue_payments.count }} customer ki payment date nikal chuki hai</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-[10px] font-black text-red-600 bg-red-200 px-2 py-1 rounded-md">VIEW ALL</span>
            <i class="fas fa-chevron-down text-red-400 group-hover:text-red-600 transition-transform"></i>
        </div>
    </button>

    <div id="overdue-box" class="hidden mt-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 animate-fade-in">
        {% for inv in overdue_payments %}
        <div class="bg-white border-l-4 border-red-600 shadow-md p-4 rounded-xl flex justify-between items-center border border-gray-100">
            <div>
                <p class="font-black text-slate-800 text-sm">{{ inv.customer.name }}</p>
                <p class="text-[9px] text-red-500 font-bold uppercase">Due Date Thi: {{ inv.due_date|date:"d M" }}</p>
                <p class="text-sm font-black text-slate-900 mt-0.5">Baki: â‚¹{{ inv.balance_amount }}</p>
            </div>
            <div class="flex gap-2">
                <a href="tel:{{ inv.customer.phone }}" class="p-2 bg-slate-50 text-slate-400 rounded-lg hover:text-blue-600 transition-colors">
                    <i class="fas fa-phone-alt text-xs"></i>
                </a>
                <a href="{% url 'add_payment' inv.id %}" class="bg-red-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black uppercase hover:bg-red-700 transition shadow-sm">
                    Vasuli
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if payments_due_today %}
<div class="mb-6">
    <h3 class="text-lg font-black text-red-600 mb-3 flex items-center tracking-tighter">
        <i class="fas fa-bell mr-2 animate-bounce"></i> AAJ KI VASULI (URGENT)
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for invoice in payments_due_today %}
        <div class="bg-white border-l-4 border-red-500 shadow-lg p-4 rounded-xl flex justify-between items-center border border-red-50">
            <div>
                <p class="font-black text-slate-800">{{ invoice.customer.name }}</p>
                <p class="text-[10px] text-slate-500">{{ invoice.customer.phone }}</p>
                <p class="text-sm text-red-600 font-black mt-1">Due: â‚¹{{ invoice.balance_amount }}</p>
            </div>
            <a href="{% url 'add_payment' invoice.id %}" class="bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-black hover:bg-red-700 shadow-md transition">
                Jama Karein
            </a>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if upcoming_payments %}
<div class="mb-10">
    <h3 class="text-sm font-black text-slate-500 uppercase tracking-widest mb-4 flex items-center">
        <i class="fas fa-calendar-alt mr-2 text-blue-500"></i> Upcoming Collection (Aane Wali Vasuli)
    </h3>
    <div class="flex flex-wrap gap-3">
        {% for inv in upcoming_payments %}
        <div class="bg-blue-50 border border-blue-100 p-4 rounded-2xl flex items-center gap-5 hover:bg-white hover:shadow-xl transition-all group cursor-default">
            <div class="text-center border-r border-blue-200 pr-4">
                <p class="text-[10px] font-black text-blue-400 uppercase tracking-tighter">{{ inv.due_date|date:"D" }}</p>
                <p class="text-lg font-black text-blue-700 leading-none">{{ inv.due_date|date:"d" }}</p>
                <p class="text-[10px] font-bold text-blue-400 uppercase">{{ inv.due_date|date:"M" }}</p>
            </div>
            <div>
                <p class="text-sm font-black text-slate-800">{{ inv.customer.name }}</p>
                <p class="text-sm font-black text-blue-600">â‚¹{{ inv.balance_amount }}</p>
                <p class="text-[9px] text-slate-400 font-bold uppercase mt-1">Status: Pending</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-4 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
    <div>
        <h1 class="text-3xl font-black text-slate-900 uppercase tracking-tighter">New Mobile Point</h1>
        <div class="flex items-center gap-3 mt-2">
            <p class="text-gray-500 text-sm border-r pr-3 font-medium">Welcome, {{ request.user.username|title }} ðŸ‘‹</p>
            <form method="GET" class="flex gap-2">
                <select name="month" onchange="this.form.submit()" class="text-xs font-bold bg-slate-100 border-none rounded-md px-2 py-1 focus:ring-2 focus:ring-blue-500 cursor-pointer">
                    {% for m in months_range %}
                        <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>Month: {{ m }}</option>
                    {% endfor %}
                </select>
                <select name="year" onchange="this.form.submit()" class="text-xs font-bold bg-slate-100 border-none rounded-md px-2 py-1 focus:ring-2 focus:ring-blue-500 cursor-pointer">
                    {% for y in years_range %}
                        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>Year: {{ y }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>
    
    <button onclick="document.getElementById('profit-card').classList.toggle('hidden')" 
            class="bg-slate-900 text-white px-6 py-3 rounded-xl shadow-lg hover:bg-slate-800 transition-all active:scale-95 text-sm font-bold flex items-center gap-2">
        <i class="fas fa-chart-pie"></i> View Business Secret
    </button>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-5 mb-8">
    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:border-blue-300 transition-all group">
        <div class="flex items-center justify-between mb-3">
            <div class="p-2 bg-blue-50 rounded-lg text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors"><i class="fas fa-shopping-cart text-lg"></i></div>
            <span class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Sales</span>
        </div>
        <p class="text-2xl font-black text-slate-800">â‚¹{{ total_sales }}</p>
    </div>

    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:border-green-300 transition-all group">
        <div class="flex items-center justify-between mb-3">
            <div class="p-2 bg-green-50 rounded-lg text-green-600 group-hover:bg-green-600 group-hover:text-white transition-colors"><i class="fas fa-wallet text-lg"></i></div>
            <span class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Received</span>
        </div>
        <p class="text-2xl font-black text-green-600">â‚¹{{ total_received }}</p>
    </div>

    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:border-orange-300 transition-all group">
        <div class="flex items-center justify-between mb-3">
            <div class="p-2 bg-orange-50 rounded-lg text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-colors"><i class="fas fa-hand-holding-usd text-lg"></i></div>
            <span class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Udhaar</span>
        </div>
        <p class="text-2xl font-black text-orange-600">â‚¹{{ total_pending }}</p>
    </div>

    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:border-red-300 transition-all group">
        <div class="flex items-center justify-between mb-3">
            <div class="p-2 bg-red-50 rounded-lg text-red-600 group-hover:bg-red-600 group-hover:text-white transition-colors"><i class="fas fa-file-invoice-dollar text-lg"></i></div>
            <span class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Expenses</span>
        </div>
        <p class="text-2xl font-black text-red-600">â‚¹{{ total_expense }}</p>
        <a href="{% url 'add_expense' %}" class="text-[9px] text-blue-500 font-bold hover:underline mt-1 block">+ Add Expense</a>
    </div>

    <div id="profit-card" class="hidden bg-slate-900 p-5 rounded-2xl shadow-xl border border-slate-700 text-white animate-fade-in">
        <div class="flex items-center justify-between mb-3">
            <div class="p-2 bg-slate-800 rounded-lg text-yellow-400"><i class="fas fa-crown text-lg"></i></div>
            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Net Profit</span>
        </div>
        <p class="text-2xl font-black text-yellow-400">â‚¹{{ net_profit }}</p>
        <p class="text-[8px] text-slate-500 mt-1 italic">After expenses</p>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-6 border-b border-gray-100 bg-slate-50 flex justify-between items-center">
            <h3 class="font-bold text-slate-800 flex items-center">
                <i class="fas fa-clock mr-2 text-orange-500"></i> Active Udhaar List
            </h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-slate-50 text-[10px] uppercase text-slate-500 font-black">
                    <tr>
                        <th class="px-6 py-4">Due Date</th>
                        <th class="px-6 py-4">Customer</th>
                        <th class="px-6 py-4">Balance</th>
                        <th class="px-6 py-4 text-center">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                    {% for invoice in pending_invoices %}
                    <tr class="hover:bg-slate-50 transition duration-150">
                        <td class="px-6 py-4 text-xs font-bold text-slate-500">{{ invoice.due_date|date:"d M, Y"|default:"TBD" }}</td>
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-800 text-sm">{{ invoice.customer.name }}</div>
                            <div class="text-[10px] text-slate-400">{{ invoice.customer.phone }}</div>
                        </td>
                        <td class="px-6 py-4 font-black text-orange-600 text-sm">â‚¹{{ invoice.balance_amount }}</td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex flex-col gap-1 max-w-[100px] mx-auto">
                                <a href="{% url 'add_payment' invoice.id %}" class="bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-green-700 transition shadow-sm border border-green-700">Pay</a>
                                <a href="{% url 'customer_detail' invoice.customer.id %}" class="text-[9px] text-slate-400 hover:text-blue-600 font-bold uppercase">History</a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="px-6 py-16 text-center text-green-600 font-black italic">Sab Clear Hai! ðŸŽ‰</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden h-fit">
        <div class="p-6 border-b border-gray-100 bg-slate-50"><h3 class="font-bold text-slate-800"><i class="fas fa-box mr-2 text-blue-500"></i> Stock Meter</h3></div>
        <div class="p-6 space-y-8">
            <div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Available</span>
                    <span class="text-sm font-black text-green-600">{{ available_products.count }} Units</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-1.5"><div class="bg-green-500 h-1.5 rounded-full" style="width: 70%"></div></div>
            </div>
            <div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Sold Out</span>
                    <span class="text-sm font-black text-red-500">{{ out_of_stock_count }} Units</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-1.5"><div class="bg-red-500 h-1.5 rounded-full" style="width: 30%"></div></div>
            </div>
            <a href="{% url 'stock_list' %}" class="block w-full text-center bg-slate-900 text-white py-4 rounded-xl hover:bg-slate-800 transition-all font-black text-xs uppercase tracking-widest shadow-lg active:scale-95">Manage Inventory</a>
        </div>
    </div>
</div>
{% endblock %}