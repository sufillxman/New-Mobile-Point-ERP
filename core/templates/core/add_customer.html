{% extends 'core/base.html' %}

{% block content %}
<div class="max-w-2xl mx-auto px-2 md:px-0">
 
    <a href="javascript:history.back()" class="inline-flex items-center text-gray-500 hover:text-slate-900 mb-6 font-bold text-sm">
        <i class="fas fa-arrow-left mr-2"></i> Cancel & Back
    </a>

    <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100 mb-10">
        <div class="bg-slate-900 p-6 md:p-10 text-white text-center">
            <h2 class="text-2xl md:text-3xl font-black uppercase tracking-tighter">Register Customer</h2>
            <p class="text-slate-400 text-xs">Choose: Live Photo or File Upload</p>
        </div>

        <form method="POST" enctype="multipart/form-data" id="customerForm" class="p-6 md:p-10 space-y-6">
            {% csrf_token %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="block text-xs font-black text-slate-500 uppercase">Full Name *</label>
                    <input type="text" name="name" required class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-green-500 outline-none font-bold">
                </div>
                <div class="space-y-2">
                    <label class="block text-xs font-black text-slate-500 uppercase">Mobile Number *</label>
                    <input type="number" name="phone" required class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-green-500 outline-none font-bold">
                </div>
            </div>

            <div class="space-y-4 border-2 border-slate-100 p-4 rounded-3xl">
                <label class="block text-xs font-black text-slate-500 uppercase text-center tracking-widest">Customer Photo</label>
                
                <div class="flex justify-center bg-slate-100 p-1 rounded-2xl gap-1">
                    <button type="button" id="tab-camera" class="flex-1 py-2 rounded-xl font-bold text-xs uppercase transition-all bg-white shadow-sm text-slate-900">Camera</button>
                    <button type="button" id="tab-upload" class="flex-1 py-2 rounded-xl font-bold text-xs uppercase transition-all text-slate-500">Upload File</button>
                </div>

                <div id="camera-box" class="space-y-4">
                    <div class="relative w-full max-w-[250px] mx-auto aspect-square bg-black rounded-full overflow-hidden border-4 border-slate-900 shadow-xl">
                        <video id="video" class="w-full h-full object-cover" autoplay playsinline></video>
                        <img id="photo-preview" class="hidden w-full h-full object-cover">
                        <canvas id="canvas" class="hidden"></canvas>
                    </div>
                    <div class="flex justify-center gap-2">
                        <button type="button" id="capture-btn" class="px-5 py-2.5 bg-blue-600 text-white rounded-full font-bold text-[10px] uppercase tracking-widest">Capture</button>
                        <button type="button" id="retake-btn" class="hidden px-5 py-2.5 bg-red-500 text-white rounded-full font-bold text-[10px] uppercase tracking-widest">Retake</button>
                    </div>
                </div>

                <div id="upload-box" class="hidden py-10 text-center border-2 border-dashed border-slate-200 rounded-3xl">
                    <input type="file" name="photo" id="file-input" class="w-full text-xs" accept="image/*">
                </div>

                <input type="hidden" name="photo_data" id="photo-data-input">
            </div>

            <div class="space-y-2">
                <label class="block text-xs font-black text-slate-500 uppercase">Address (Optional)</label>
                <textarea name="address" rows="2" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none font-bold"></textarea>
            </div>

            <button type="submit" class="w-full py-5 bg-green-600 text-white font-black uppercase tracking-widest text-sm rounded-2xl hover:bg-green-700 shadow-xl active:scale-95 transition-all">
                Register & Save
            </button>
        </form>
    </div>
</div>

<script>
    const cameraBtn = document.getElementById('tab-camera');
    const uploadBtn = document.getElementById('tab-upload');
    const cameraBox = document.getElementById('camera-box');
    const uploadBox = document.getElementById('upload-box');
    
    cameraBtn.onclick = () => {
        cameraBox.classList.remove('hidden'); uploadBox.classList.add('hidden');
        cameraBtn.classList.add('bg-white', 'shadow-sm', 'text-slate-900'); uploadBtn.classList.remove('bg-white', 'shadow-sm');
    };
    uploadBtn.onclick = () => {
        uploadBox.classList.remove('hidden'); cameraBox.classList.add('hidden');
        uploadBtn.classList.add('bg-white', 'shadow-sm', 'text-slate-900'); cameraBtn.classList.remove('bg-white', 'shadow-sm');
    };

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const photoPreview = document.getElementById('photo-preview');
    const captureBtn = document.getElementById('capture-btn');
    const retakeBtn = document.getElementById('retake-btn');
    const photoDataInput = document.getElementById('photo-data-input');

    // Mobile Camera Fix: High Resolution avoid karne ke liye constraints
    navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 640 } } 
    })
    .then(stream => { video.srcObject = stream; })
    .catch(err => alert("Camera blocked! Settings mein jake allow karein."));

    captureBtn.onclick = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        // Quality 0.7 rakhi hai taaki mobile network par fast upload ho
        const data = canvas.toDataURL('image/jpeg', 0.7);
        photoPreview.src = data;
        photoDataInput.value = data;
        
        video.classList.add('hidden');
        photoPreview.classList.remove('hidden');
        captureBtn.classList.add('hidden');
        retakeBtn.classList.remove('hidden');
    };

    retakeBtn.onclick = () => {
        video.classList.remove('hidden');
        photoPreview.classList.add('hidden');
        captureBtn.classList.remove('hidden');
        retakeBtn.classList.add('hidden');
        photoDataInput.value = "";
    };
</script>
{% endblock %}